<!DOCTYPE html>
<html>
<head>
<title>vio: tile packer</title>
<link rel="stylesheet" href="lib/common.css">
<style type="text/css">
* {
  box-sizing: border-box;
}
body,html {
  padding: 0; margin:0;
  height: 100%;
  font-family: sans-serif;
}
.hbox {
  height: 100%;
}
.item {
  overflow: auto;
}
#canvas {
  background-color: #999;
}
#log {
  font-size: 10pt;
}
</style>

<script type="text/javascript" src="lib/Branch.js"></script>
<script type="text/javascript">
window.addEventListener('dragover', function(evt) { evt.preventDefault(); }, false); window.addEventListener('drop', function(evt) { evt.preventDefault(); }, false);

var canvas, e_drop, e_filetree;
function gogogo() {
  e_display = document.getElementById('display');
  canvas = document.getElementById('canvas');
  e_drop = document.getElementById('drop');
  e_filetree = document.getElementById('filetree');
  e_outtree = document.getElementById('outtree');
  e_log = document.getElementById('log');

  var ctx = canvas.getContext('2d');

  var pairs = {};
  var filetree = new Branch(e_filetree, "Input Files");
  var outtree = new Branch(e_outtree, "Output Files");

  /* ================ Canvas ================ */
  function handleResize() {
    var win = window.getComputedStyle(e_display, null);
    var d_w = parseInt(win.getPropertyValue('width'));
    var d_h = parseInt(win.getPropertyValue('height'));
  }
  window.addEventListener('resize', handleResize);
  handleResize();
  /* ================ Etc ================ */
  function doLog(msg) {
    var emsg = document.createElement('div');
    emsg.innerHTML = new Date().getTime() + ': ' + msg;
    e_log.appendChild(emsg);
    e_log.scrollTop = Math.max(e_log.scrollHeight, e_log.clientHeight) - e_log.clientHeight;
  }

  /* ================ Pack Grid ================ */
  function PackGrid() {
    var width = 0;
    var height = 0;
    var grid = [];

    function checkGridSpace(x, y) {
      if (x >= width || x < 0 || y >= height || y < 0) return false;
      if (grid[x][y].open) return true;
      return false;
    }
    function findGridSpace(w, h) {
      for (var gx = 0; gx < width; gx++) {
        for (var gy = 0; gy < height; gy++) {
          var okay = true;
          for (var wx = 0; wx <= w; wx++) {
            if (!(okay = checkGridSpace(gx+wx, gy))) break;
            for (var wy = 0; wy <= h; wy++) {
              if (!(okay = checkGridSpace(gx+wx, gy+wy))) break;
            }
            if (!okay) break;
          }
          if (okay) {
            return {x: gx, y: gy, w: w, h: h};
          }
        } // end gy
      } // end gx
      return null;
    }
    function growGrid(gx, gy) {
      for (var grow_x = 0; grow_x < gx; grow_x++) {
        grid[width+grow_x] = [];
        for (var y = 0; y < height; y++) {
          grid[width+grow_x][y] = {open: true};
        }
      }
      width += gx;

      for (var grow_y = 0; grow_y < gy; grow_y++) {
        for (var x = 0; x < width; x++) {
          grid[x][height+grow_y] = {open: true};
        }
      }
      height += gy;
    }
    function closeGridSpaces(gx, gy, gw, gh) {
      for (var x = gx; x < gx+gw; x++) {
        for (var y = gy; y < gy+gh; y++) {
          grid[x][y].open = false;
        }
      }
    }
    
    this.checkGridSpace = checkGridSpace;
    this.findGridSpace = findGridSpace;
    this.growGrid = growGrid;
    this.closeGridSpaces = closeGridSpaces;
    this.getWidth = function() { return width; };
    this.getHeight = function() { return height; };
  }
  /* ================ Cropping ================ */
  function getCroppedSize(f) {
    canvas.width = f.w;
    canvas.height = f.h;
    ctx.drawImage(pairs[f.i].image, f.x, f.y, f.w, f.h, 0, 0, f.w, f.h);

    var idat = ctx.getImageData(0, 0, f.w, f.h);
    var pixels = idat.data;
    var x0 = -1, x1 = -1, y0 = -1, y1 = -1;
    for (var i = 0, n = pixels.length; i < n; i +=4) {
      var p = i / 4;
      var x = p % canvas.width;
      var y = Math.floor(p / canvas.width);
      if (pixels[i+3] > 0) {
        if (x0 == -1 || x < x0) x0 = x;
        if (x1 == -1 || x > x1) x1 = x;
        if (y0 == -1 || y < y0) y0 = y;
        if (y1 == -1 || y > y1) y1 = y;
      }
    }
    // FIXME
    //if (x0 > 0) x0--;
    //if (y0 > 0) y0--;
    x1++;
    y1++;
    //console.log(x0+'x'+x1+' '+y0+'x'+y1);
    //console.log((x1-x0)+'x'+(y1-y0));

    return {xmin:x0, xmax:x1, ymin:y0, ymax:y1};
  }

  /* ================ Packing ================ */
  var all_frames = [];
  var pending_frames = [];
  var optimized_frames = [];
  function packImages() {
    collectFrames();
    combineFrames();
  }
  document.getElementById('pack').addEventListener('click', packImages);
  function combineFrames() {
    var grid = new PackGrid();
    var width = 0;
    var height = 0;
    var x = 0;
    var y = 0;
    pending_frames = all_frames.slice(0);
    console.log(all_frames);
    for (var i = 0; i < pending_frames.length; i++) {
      var f = pending_frames[i];

      var c = getCroppedSize(pending_frames[i]);
      pending_frames[i].c = c;
      var w = (c.xmax-c.xmin) || 1;
      var h = (c.ymax-c.ymin) || 1;

      var space = null;
      while (!(space = grid.findGridSpace(w, h))) {
        grid.growGrid(1,1);
      }
      grid.closeGridSpaces(space.x, space.y, space.w, space.h);
      pending_frames[i].space = space;
    }
    canvas.width = grid.getWidth();
    canvas.height = grid.getHeight();
    for (i = 0; i < pending_frames.length; i++) {
      var f = pending_frames[i];
      var c = f.c;
      var x = f.x+c.xmin;
      var y = f.y+c.ymin;
      var w = (c.xmax-c.xmin) || 1;
      var h = (c.ymax-c.ymin) || 1;

      ctx.strokeStyle = "#FFFF00";
      // THE MYSTERIES OF HTML5 CANVII
      //ctx.strokeRect(x+0.5, y+0.5, w, h);
      //ctx.strokeRect(f.space.x+0.5, f.space.y+0.5, f.space.w, f.space.h);
      ctx.drawImage(pairs[f.i].image, x, y, w, h, f.space.x, f.space.y, f.space.w, f.space.h);
      //ctx.drawImage(pairs[f.i].image, x, y, w, h, x, y, w, h);
      //ctx.drawImage(pairs[f.i].image, x, y, w, h, f.space.x, f.space.y, f.space.w, f.space.h);
      //ctx.drawImage(pairs[f.i].image, f.x, f.y, f.w, f.h, f.space.x, f.space.y, f.space.w, f.space.h);
    }
    /*console.log(grid.getWidth()+'x'+grid.getHeight());
    canvas.width = grid.getWidth();
    canvas.height = grid.getHeight();
    for (x = 0; x < grid.getWidth(); x++) {
      for (y = 0; y < grid.getHeight(); y++) {
        ctx.fillStyle = (grid.checkGridSpace(x,y) ? '#ffffff' : '#000000');
        ctx.fillRect(x, y, 1, 1);
      }
    }*/
  }
  function collectFrames() {
    all_frames = [];
    for (i in pairs) {
      if (!pairs[i].json) {
        doLog(i+' has no JSON, skipping');
        continue;
      }
      doLog('analyzing ' + i + '...');
      var json = eval('({'+pairs[i].json+'})');
      var frames = getFrames(json, i);
      doLog('... found ' + frames.length + ' frames');
      all_frames = all_frames.concat(frames);
    }
    doLog('Total frames: ' + all_frames.length);
  }
  function getFrames(json, i) {
    if (!json) return [];
    var sprites = [];
    json.C = json.C || {};
    var ox = json.C.x || 0, oy = json.C.y || 0;
    var ow = json.C.w || 0, oh = json.C.h || 0;
    for (a in json.A) {
      var A = json.A[a];
      A.C = A.C || {};
      ax = A.C.x || ox, ay = A.C.y || oy;
      aw = A.C.w || ow, ah = A.C.h || oh;
      if (A.C.r && A.C.c) {
        for (var y = 0; y < A.C.r; y++) {
          for (var x = 0; x < A.C.c; x++) {
            sprites.push({x: ax+x*aw, y: ay+y*ah, w: aw, h: ah, a: a, s: 0, f: (y*A.C.c)+x, i: i});
          }
        }
      }
      for (s in A.S) {
        var S = A.S[s];
        S.C = S.C || {};
        sx = S.C.x || ax, sy = S.C.y || ay;
        sw = S.C.w || aw, sh = S.C.h || ah;
        for (f in S.F) {
          var F = S.F[f];
          var fx, fy, fw, fh;
          if (F.constructor === Array) {
            fx = F[0] || sx, fy = F[1] || sy;
            fw = F[2] || sw, fh = F[3] || sh;
          } else {
            fx = F.x || sx, fy = F.y || sy;
            fw = F.w || sw, fh = F.h || sh;
          }
          sprites.push({x: parseInt(fx), y: parseInt(fy), w: parseInt(fw), h: parseInt(fh), a: a, s: s, f: parseInt(f), i: i});
        }
        if (S.C.r && S.C.c) {
          for (var y = 0; y < S.C.r; y++) {
            for (var x = 0; x < S.C.c; x++) {
              sprites.push({x: sx+x*sw, y: sy+y*sh, w: sw, h: sh, a: a, s: s, f: S.F.length+(y*S.C.c)+x, i: i});
            }
          }
        }
      }
    }
    return sprites;
  }
  /* ================ Drop Handling ================ */
  function addImage(name, data) {
    var branch = filetree.getBranch(name) || filetree.addBranch(name);
    var ibranch = branch.getBranch('image') || branch.addBranch('image');
    if (!branch.getInput('delete')) {
      branch.addInput("button", "delete", '-', function(cb) {
        console.log(branch.getText());
        branch.implode();
      });
    }
    doLog('added ' + name + ' image');
  }
  function addJSON(name, data) {
    var branch = filetree.getBranch(name) || filetree.addBranch(name);
    var jbranch = branch.getBranch('json') || branch.addBranch('json');
    if (!branch.getInput('delete')) {
      branch.addInput("button", "delete", '-', function(cb) {
        delete pairs[branch.getText()];
        branch.implode();
      });
    }
    doLog('added ' + name + ' JSON');
  }
  // set up dropping
  document.getElementById('drop').addEventListener('drop', function(evt) {
    evt.preventDefault();
    var files = evt.dataTransfer.files;
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      if (typeof FileReader !== 'undefined') {
        var reader = new FileReader;
        if (file.type.indexOf('image') != -1) {
          (function(f){
            var fname = f.substring(0,f.lastIndexOf('.'));
            if (!pairs[fname]) pairs[fname] = { image: null, json: null };
            reader.onload = function(evt) {
              pairs[fname].image = new Image();
              pairs[fname].image.onload = function() {
                addImage(fname);
              };
              pairs[fname].image.src = evt.target.result;
            };
            reader.readAsDataURL(file);
          })(file.name);
        } else {
          (function(f){
            var fname = f.substring(0,f.lastIndexOf('.'));
            if (!pairs[fname]) pairs[fname] = { image: null, json: null };
            reader.onload = function(evt) {
              pairs[fname].json = evt.target.result;
              addJSON(fname);
            };
            reader.readAsText(file);
          })(file.name);
        }
      }
    }
  }, false);
}

window.onload = gogogo;
</script>
</head>
<body>
<div class="hbox">
  <div class="vbox" id="drop">
    <div class="citem">Drop PNGs and JSON here</div>
    <div style="flex:4" class="item" id="filetree"></div>
    <div style="font-size:10pt" class="item">
      <label for="grow">Grid Cell Size: </label><input type="number" value="8" id="cell"/>
      <label for="grow">Grow Value: </label><input type="number" value="1" id="grow"/>
      <br/>
      <label for="direction">Grow Direction:</label>
      right<input type="radio" name="direction" value="right"/>
      down<input type="radio" name="direction" value="down"/>
      both<input type="radio" name="direction" value="both" checked/>
      <br/>
      <button id="pack">Pack Images</button>
    </div>
  </div>
  <div style="flex:4" class="vbox">
    <div style="flex:8" class="vbox">
      <div class="citem" id="display">
        <canvas id="canvas"></canvas>
      </div>
      <div class="item" id="outtree"></div>
    </div>
    <div class="item" id="log"></div>
  </div>
</div>
</body>
